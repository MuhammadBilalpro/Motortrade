name: Deploy to Ubuntu VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server and setup
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "=== Starting deployment on Ubuntu 24 LTS ==="
          
          # Update system packages
          echo "Updating system packages..."
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -y
          
          # Install essential dependencies
          echo "Installing essential dependencies..."
          apt-get install -y software-properties-common curl wget git unzip lsb-release ca-certificates apt-transport-https
          
          # Install Composer
          echo "Installing Composer..."
          if [ ! -f "/usr/local/bin/composer" ]; then
            curl -sS https://getcomposer.org/installer | php
            mv composer.phar /usr/local/bin/composer
            chmod +x /usr/local/bin/composer
          fi
          composer --version
          
          # Add PHP repository for Ubuntu 24.04
          echo "Adding PHP repository..."
          add-apt-repository -y ppa:ondrej/php
          apt-get update -y
          
          # Install PHP (try 8.3 first, fallback to 8.2, then default)
          echo "Installing PHP and extensions..."
          if apt-get install -y php8.3 php8.3-cli php8.3-common php8.3-mysql php8.3-zip php8.3-gd php8.3-mbstring php8.3-curl php8.3-xml php8.3-bcmath libapache2-mod-php8.3 2>/dev/null; then
            PHP_VERSION="8.3"
            PHP_MODULE="php8.3"
          elif apt-get install -y php8.2 php8.2-cli php8.2-common php8.2-mysql php8.2-zip php8.2-gd php8.2-mbstring php8.2-curl php8.2-xml php8.2-bcmath libapache2-mod-php8.2 2>/dev/null; then
            PHP_VERSION="8.2"
            PHP_MODULE="php8.2"
          else
            # Fallback to default PHP
            apt-get install -y php php-cli php-common php-mysql php-zip php-gd php-mbstring php-curl php-xml php-bcmath libapache2-mod-php
            PHP_VERSION=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
            PHP_MODULE="php"
          fi
          
          # Install Apache web server
          echo "Installing Apache web server..."
          apt-get install -y apache2
          
          # Enable required Apache modules
          echo "Enabling Apache modules..."
          a2enmod rewrite
          a2enmod $PHP_MODULE
          
          # Verify PHP is working
          echo "Verifying PHP installation..."
          php -v
          
          # Restart Apache to apply changes
          systemctl restart apache2
          
          # Test PHP processing
          echo "Testing PHP processing..."
          echo "<?php phpinfo(); ?>" > /tmp/test_php.php
          php /tmp/test_php.php > /dev/null 2>&1 && echo "✓ PHP CLI working" || echo "⚠ PHP CLI issue"
          rm /tmp/test_php.php
          
          # Create web directory if it doesn't exist
          echo "Setting up web directory..."
          mkdir -p /var/www/html
          cd /var/www/html
          
          # Initialize git if not already done
          if [ ! -d ".git" ]; then
            echo "Initializing git repository..."
            git init
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
          fi
          
          # Add remote if not exists
          if ! git remote | grep -q origin; then
            echo "Adding git remote..."
            git remote add origin https://github.com/${{ github.repository }}.git || true
          fi
          
          # Deploy latest code - always force pull to ensure latest version
          echo "Deploying latest code..."
          cd /var/www/html
          
          # Fix git ownership issue to prevent "dubious ownership" errors
          echo "Fixing git ownership and configuration..."
          if [ -d ".git" ]; then
            # Fix ownership of .git directory
            chown -R root:root /var/www/html/.git 2>/dev/null || true
            # Add safe directory to git config
            git config --global --add safe.directory /var/www/html || true
            # Ensure git config is accessible
            git config --global user.name "GitHub Actions" || true
            git config --global user.email "actions@github.com" || true
          fi
          
          # Remove existing files (except .git if it exists)
          if [ -d ".git" ]; then
            echo "Updating existing repository..."
            # Fetch latest changes
            git fetch origin || {
              echo "Git fetch failed, trying to fix ownership..."
              chown -R root:root /var/www/html/.git
              git config --global --add safe.directory /var/www/html
              git fetch origin
            }
            # Reset to latest code
            git reset --hard origin/main 2>/dev/null || git reset --hard origin/master 2>/dev/null || {
              echo "Git reset failed, trying to fix ownership..."
              chown -R root:root /var/www/html/.git
              git config --global --add safe.directory /var/www/html
              git reset --hard origin/main 2>/dev/null || git reset --hard origin/master 2>/dev/null || true
            }
            git clean -fd
          else
            echo "Cloning fresh repository..."
            rm -rf * .[^.]* 2>/dev/null || true
            git clone https://github.com/${{ github.repository }}.git .
            git checkout main 2>/dev/null || git checkout master 2>/dev/null || true
            # Set ownership after clone
            chown -R root:root /var/www/html/.git 2>/dev/null || true
            git config --global --add safe.directory /var/www/html || true
          fi
          
          # Install PHP dependencies via Composer
          echo "Installing PHP dependencies via Composer..."
          cd /var/www/html
          composer install --no-dev --optimize-autoloader
          
          # Verify vendor/autoload.php exists
          if [ ! -f "/var/www/html/vendor/autoload.php" ]; then
            echo "✗ ERROR: vendor/autoload.php NOT FOUND! Running composer install again..."
            composer install --no-dev --optimize-autoloader
          else
            echo "✓ vendor/autoload.php exists"
          fi
          
          # Verify we have the latest code
          echo "Current commit:"
          git log -1 --oneline
          echo ""
          echo "=== Verifying deployment ==="
          echo "Checking if index.php exists..."
          if [ -f "index.php" ]; then
            echo "✓ index.php exists"
            echo "Checking if footer.php exists..."
            if [ -f "footer.php" ]; then
              echo "✓ footer.php exists"
            else
              echo "✗ ERROR: footer.php NOT FOUND!"
            fi
            echo "Checking if index.php includes footer..."
            if grep -q "footer.php" index.php; then
              echo "✓ Footer include found in index.php"
              echo "Last 5 lines of index.php:"
              tail -5 index.php
            else
              echo "✗ ERROR: Footer include NOT FOUND in index.php!"
            fi
          else
            echo "✗ ERROR: index.php NOT FOUND!"
          fi
          echo "==========================="
          
          # Set proper permissions
          echo "Setting file permissions..."
          # Keep .git owned by root for git operations, but make it accessible
          if [ -d "/var/www/html/.git" ]; then
            chown -R root:root /var/www/html/.git
            chmod -R 755 /var/www/html/.git
          fi
          # Set ownership for web files (www-data for Apache)
          chown -R www-data:www-data /var/www/html
          # But keep .git accessible for future deployments
          if [ -d "/var/www/html/.git" ]; then
            chown -R root:root /var/www/html/.git
          fi
          chmod -R 755 /var/www/html
          chmod -R 775 /var/www/html 2>/dev/null || true
          # Ensure .git is readable but owned by root
          if [ -d "/var/www/html/.git" ]; then
            chmod -R 755 /var/www/html/.git
          fi
          
          # Create config directory if it doesn't exist
          echo "Setting up config files..."
          mkdir -p /var/www/html/config
          
          # Create email_config.php with real values
          echo "Creating email_config.php..."
          cat > /var/www/html/config/email_config.php << 'EMAIL_EOF'
          <?php
          // Hostinger Email Configuration - Exact Server Settings
          // Webmail: https://mail.hostinger.com/v2/
          
          // Outgoing Server (SMTP) - Exact Hostinger Settings
          define('SMTP_HOST', 'smtp.hostinger.com');
          define('SMTP_PORT', 465); // Hostinger SMTP Port
          define('SMTP_USERNAME', 'james@motortradeinsurancesra.co.uk');
          define('SMTP_PASSWORD', 'Sra133719@');
          define('SMTP_ENCRYPTION', 'ssl'); // Hostinger uses SSL
          
          // Incoming Server (IMAP) - For reference (email clients)
          define('IMAP_HOST', 'imap.hostinger.com');
          define('IMAP_PORT', 993);
          define('IMAP_ENCRYPTION', 'ssl');
          
          // Incoming Server (POP) - For reference (email clients)
          define('POP_HOST', 'pop.hostinger.com');
          define('POP_PORT', 995);
          define('POP_ENCRYPTION', 'ssl');
          
          // Email Addresses
          define('RECIPIENT_EMAIL', 'james@motortradeinsurancesra.co.uk');
          define('FROM_EMAIL', 'james@motortradeinsurancesra.co.uk');
          define('FROM_NAME', 'Motor Trade Referrals');
          ?>
          EMAIL_EOF
          
          # Create google_credentials.json with real values
          echo "Creating google_credentials.json..."
          cat > /var/www/html/config/google_credentials.json << 'GOOGLE_EOF'
          {
            "type": "service_account",
            "project_id": "gen-lang-client-0652227259",
            "private_key_id": "1a9691dbfa16207213a4e24848c05f423cb58373",
            "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCV2OwFPDJWahvg\nmAk/FfkLRDSA6R7hBk5R5/nEijjD7SNfgdTh0GZDUKXh3praGFm6BNN1Ud6fnL8x\nd+s7GMgV+/TrfE4J534Ma6rxAnlxO2mUEBYxTm5z8zSQR8aqVZeCkYGhf7Qt8wRk\nBH5tH3XZyeQ2g7mAKKwqH+Bgy/UGZPC4jjKXTRGPgYPwGISnPf+dVlDTl+RAEEkK\nFR1Y7AROVnbvSu80piXpLleDCRmCjITDblyHmZf0+6K4WcdctHlZ6suVB9nQJC95\nRCCMc7/A47+0dTEdq0Qfc/Ukn1R0HGJOxy6q1sXydpyuirOCEe2iw7wJ7V6FVdWp\nIHQHQoY/AgMBAAECggEAM7ExOl0ZwFW6aDAKgIjD8O8GbbH9xQK34el0cCh+jJgx\nq7DOD1gk7vPTRafVI4di7JjdmYs0kTsxeY80xp4159+TDelDwobpJL+/qISCAF3O\nfhVOkpPL5pPvfhZEol4EdjZb0aqMLY235gjm1B4WOZs77tJiG6PsQFveu4WgcSO5\n9kj969u2CjC1fUZTrHbTOSzh7pDrfEZX8j40aXtahu3ZKfQErFpNWnrchvNlZWEu\nkWSd5LLjwbujuoKoTGLEJnd3QjQHo46QHrtNTv14ng4zwsaxwk0iFfCQpENHHGW6\nK5kEYdY6kYAyVV0TvGkXpnsbzeQeDZIbuQy6rKdAgQKBgQDJtXdpHxFUXPNCLWKJ\nzr/fIDx87qsk+54IMudOmUKUAhOtqPIforvc/b+nVTtLl21JuP94hzk9eGcX4UiV\nV9NA4VFwpFG+IO2oj7X5jl9ImW2ejHiR6Mes5jjs2rgz/+9dByB5bjNFNHy0Z9ZO\nUQ5VT/LclHVbBq6zUNWnXonaYwKBgQC+Lf52QWjUgJDMBRF2YBLf/Y14/vtO+INq\nxp9UL/4u3jFkdAjtpAtUdfAmGmtJYVrK3UjaHM/chI8LlfP+k4Utfv1jtVbhQp56\nzeMrCwChmYY7xx7+ZxZFHdfa8LhvoYFfq84F6v1oA8mr4cwGsSP6tMzcdUncKSLz\n1nmuelGddQKBgFPg/4AaaEVxxcLORrzR2h46NI0rXsYpUEVOjbu0pegQmQhNSip3\nrLGwX6OBIQBFPzA6GxqO+PGkARMAHwPjmrjPOeOioU90OAAxitX1K5BwJRKajYT3\njRlMP33XUmRlWK+RyCJW/kEYG4eV6pt0v4YgkfjCT68Dr2BoDADmomLLAoGBAKAJ\nuG7vUDYzEqZ9RVqmMnwHtLuzZuvnuT9rcby4vl/WXx43fyPrvhUPQk3uQYZ4xJye\nZqYVRN4/Ntj7EV6T6aiFitoTSc857n9NLvOTyK40sX8wa2aOfXEgUftOQwa9lE9c\nFn1oaGLVfSqFUtn2y144M4T5tnPsshsbyz4GdRPZAoGAESQfp0G2OXGj9HO5rNJM\n6erWyAoNSRS2u94IqlTYzhuhHMtFeiZ17Jv5+RiuSf0Ssv9b23TPZTEe0f+Ealn7\nwMujr+2/Vuqpn5jFn7Oyu8KGXAlwoK3KQSgv/4dIMZryphxpkUSgV4IcegE1Raut\niXrfCPjvKUp5i8UD2OQepDI=\n-----END PRIVATE KEY-----\n",
            "client_email": "sra-990@gen-lang-client-0652227259.iam.gserviceaccount.com",
            "client_id": "103693685270061292389",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/sra-990%40gen-lang-client-0652227259.iam.gserviceaccount.com",
            "universe_domain": "googleapis.com"
          }
          GOOGLE_EOF
          
          # Set proper permissions for config files
          chown www-data:www-data /var/www/html/config/email_config.php
          chmod 600 /var/www/html/config/email_config.php
          chown www-data:www-data /var/www/html/config/google_credentials.json
          chmod 600 /var/www/html/config/google_credentials.json
          
          # Create enquiries.csv file with proper permissions if it doesn't exist
          if [ ! -f "/var/www/html/enquiries.csv" ]; then
            touch /var/www/html/enquiries.csv
            chown www-data:www-data /var/www/html/enquiries.csv
            chmod 664 /var/www/html/enquiries.csv
          fi
          
          # Configure Apache virtual host
          echo "Configuring Apache virtual host..."
          cat > /etc/apache2/sites-available/000-default.conf << 'EOF'
          <VirtualHost *:80>
              ServerAdmin webmaster@localhost
              DocumentRoot /var/www/html
              
              <Directory /var/www/html>
                  Options Indexes FollowSymLinks
                  AllowOverride All
                  Require all granted
              </Directory>
              
              ErrorLog ${APACHE_LOG_DIR}/error.log
              CustomLog ${APACHE_LOG_DIR}/access.log combined
          </VirtualHost>
          EOF
          
          # Enable site and restart Apache
          a2ensite 000-default.conf
          systemctl reload apache2
          
          # Check Apache status
          systemctl status apache2 --no-pager
          
          # Display PHP version
          echo "=== Installation Summary ==="
          php -v
          echo "=== Deployment completed successfully ==="
